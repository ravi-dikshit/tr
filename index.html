<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tenali Rama – Playlist Browser - Version 3.0</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="Tenali-Ramakrishna.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333;
    }
    .header { 
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
      padding: 1rem; display: flex; gap: 1rem; align-items: center; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .logo { height: 40px; width: auto; border-radius: 8px; }
    h1 { font-size: 1.4rem; font-weight: 700; color: #4a5568; margin: 0; }
    .main { display: flex; min-height: calc(100vh - 140px); gap: 2rem; padding: 2rem; }
    .player-section { flex: 1; max-width: 800px; }
    #player { width: 100%; height: 400px; border-radius: 12px; border: none; }
    .video-info { background: white; padding: 1.5rem; border-radius: 12px; margin-top: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .video-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: #2d3748; }
    .nav-buttons { display: flex; gap: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 25px; background: #4299e1; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; min-height: 48px; min-width: 100px; }
    .btn:hover { background: #3182ce; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66,153,225,0.4); }
    .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; }
    .playlist-section { flex: 1; max-width: 500px; }
    .playlist-controls { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .search-container { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    #search { flex: 1; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 25px; font-size: 1rem; min-height: 48px; }
    #search:focus { outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66,153,225,0.1); }
    #clearBtn { padding: 0.75rem 1rem; background: #f56565; color: white; border: none; border-radius: 25px; cursor: pointer; min-height: 48px; }
    #clearBtn:hover { background: #e53e3e; }
    .range-toggle { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    #rangeFilter, #resumeToggle { padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 0.95rem; min-height: 40px; }
    #rangeFilter:focus, #resumeToggle:focus { outline: none; border-color: #4299e1; }
    #playlist { 
      max-height: 70vh; overflow-y: auto; background: white; 
      border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 1rem; 
    }
    .episode-card { 
      display: flex; gap: 1rem; padding: 1rem; border-radius: 12px; 
      cursor: pointer; transition: all 0.2s; margin-bottom: 0.75rem; 
      border: 2px solid transparent; position: relative;
    }
    .episode-card:hover { background: #f7fafc; transform: translateX(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .episode-card.active { 
      background: linear-gradient(135deg, #4299e1, #3182ce); color: white; 
      border-color: #3182ce; box-shadow: 0 8px 25px rgba(66,153,225,0.4);
    }
    .episode-card.active .episode-number { background: rgba(255,255,255,0.2); color: white; }
    .episode-card img { 
      width: 80px; height: 45px; object-fit: cover; border-radius: 8px; 
      flex-shrink: 0;
    }
    .episode-card img.lazy { opacity: 0.5; transition: opacity 0.3s; }
    .episode-card img:not(.lazy) { opacity: 1; }
    .episode-info { flex: 1; min-width: 0; }
    .episode-number { 
      background: #e2e8f0; color: #4a5568; padding: 0.25rem 0.75rem; 
      border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block;
    }
    .episode-title { font-weight: 500; margin-top: 0.25rem; font-size: 0.95rem; line-height: 1.4; }
    .footer { text-align: center; padding: 2rem; color: rgba(255,255,255,0.9); font-size: 0.9rem; }
    @media (max-width: 768px) { 
      .main { flex-direction: column; padding: 1rem; }
      .playlist-section { max-width: none; order: -1; }
      #player { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="Tenali-Ramakrishna.png" alt="Tenali Rama" class="logo">
    <h1>Tenali Rama – Playlist Browser - Version 3.0</h1>
  </div>
  
  <div class="main">
    <div class="player-section">
      <iframe id="player" src="" frameborder="0" allowfullscreen></iframe>
      <div class="video-info" id="videoInfo" style="display: none;">
        <div class="video-title" id="videoTitle"></div>
        <div class="nav-buttons">
          <button id="prevBtn" class="btn">Previous</button>
          <button id="nextBtn" class="btn">Next</button>
        </div>
      </div>
    </div>
    
    <div class="playlist-section">
      <div class="playlist-controls">
        <div class="search-container">
          <input type="text" id="search" placeholder="Search episodes..." />
          <button id="clearBtn">Clear</button>
        </div>
        <div class="range-toggle">
          <label>Range: </label>
          <select id="rangeFilter">
            <option value="all">All Episodes</option>
            <option value="1-100">1-100</option>
            <option value="101-200">101-200</option>
            <option value="201-300">201-300</option>
            <option value="301-400">301-400</option>
            <option value="401-500">401-500</option>
            <option value="501-600">501-600</option>
            <option value="601-700">601-700</option>
            <option value="701+">701+</option>
          </select>
          <label style="margin-left: 2rem;">
            <input type="checkbox" id="resumeToggle" checked> Resume last episode
          </label>
        </div>
      </div>
      <div id="playlist"></div>
    </div>
  </div>
  
  <div class="footer">
    © 2025 All rights reserved. Ravi Dikshit
  </div>

  <script>
    const API_KEY = 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8';
    const PLAYLIST_ID = 'PLbZxdQd9WcS0w2N8U1t6A5_GnEeWmRB4Y';
    const LS_LAST_INDEX = 'tenali_last_index';
    const LS_RANGE_FILTER = 'tenali_range_filter';
    const LS_RESUME_TOGGLE = 'tenali_resume_toggle';
    
    let allEpisodes = [];
    let filteredEpisodes = [];
    let currentIndex = -1;
    let isLoading = false;

    // 1x1 transparent placeholder
    const PLACEHOLDER = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';

    function createEpisodeCard(episode, index) {
      const card = document.createElement('div');
      card.className = 'episode-card';
      card.dataset.index = index;
      
      const img = document.createElement('img');
      img.src = PLACEHOLDER;
      img.dataset.src = episode.thumbnails?.medium?.url || '';
      img.alt = episode.title;
      img.className = 'lazy';
      
      const info = document.createElement('div');
      info.className = 'episode-info';
      
      const number = document.createElement('div');
      number.className = 'episode-number';
      number.textContent = `#${index + 1}`;
      
      const title = document.createElement('div');
      title.className = 'episode-title';
      title.textContent = episode.title;
      
      info.appendChild(number);
      info.appendChild(title);
      card.appendChild(img);
      card.appendChild(info);
      
      card.addEventListener('click', () => playEpisode(index));
      return card;
    }

    function renderInitialChunk(episodes, start, end) {
      const container = document.getElementById('playlist');
      const fragment = document.createDocumentFragment();
      
      for (let i = start; i < end && i < episodes.length; i++) {
        const card = createEpisodeCard(episodes[i], i);
        fragment.appendChild(card);
      }
      
      container.appendChild(fragment);
    }

    function setupLazyLoading() {
      const images = document.querySelectorAll('#playlist img[data-src]');
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.classList.remove('lazy');
              observer.unobserve(img);
            }
          });
        }, { rootMargin: '200px 0px' });
        
        images.forEach(img => observer.observe(img));
      } else {
        // Fallback: load all immediately
        images.forEach(img => {
          img.src = img.dataset.src;
          img.classList.remove('lazy');
        });
      }
    }

    async function loadPlaylist() {
      if (isLoading) return;
      isLoading = true;
      
      try {
        const playlist = document.getElementById('playlist');
        playlist.innerHTML = '<div style="padding:1rem;text-align:center;color:#666;">Loading episodes...</div>';
        
        let allItems = [];
        let nextPageToken = '';
        
        do {
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${PLAYLIST_ID}&key=${API_KEY}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`
          );
          const data = await response.json();
          
          allItems = allItems.concat(data.items.map(item => ({
            id: item.snippet.resourceId.videoId,
            title: item.snippet.title,
            thumbnails: item.snippet.thumbnails
          })));
          
          nextPageToken = data.nextPageToken;
        } while (nextPageToken);
        
        // Sort by title (usually chronological)
        allEpisodes = allItems.sort((a, b) => a.title.localeCompare(b.title));
        filteredEpisodes = [...allEpisodes];
        
        // Restore preferences
        document.getElementById('rangeFilter').value = localStorage.getItem(LS_RANGE_FILTER) || 'all';
        document.getElementById('resumeToggle').checked = localStorage.getItem(LS_RESUME_TOGGLE) !== 'false';
        
        const savedIndex = parseInt(localStorage.getItem(LS_LAST_INDEX) || '0');
        let priorityStart = 0, priorityEnd = 20;
        
        // Priority window around saved position
        if (savedIndex > 20 && savedIndex < allEpisodes.length) {
          priorityStart = Math.max(0, savedIndex - 26);
          priorityEnd = Math.min(allEpisodes.length, savedIndex + 20);
        }
        
        // Phase 1: Render first 20 immediately
        renderInitialChunk(allEpisodes, 0, 20);
        
        // Phase 2: Priority window (episode 116 area)
        if (priorityStart > 0 && priorityStart < allEpisodes.length) {
          renderInitialChunk(allEpisodes, priorityStart, priorityEnd);
        }
        
        // Phase 3: Setup lazy loading observer
        setupLazyLoading();
        
        // Phase 4: Background render remaining chunks
        let chunkStart = Math.max(20, priorityEnd);
        function backgroundRender() {
          if (chunkStart >= allEpisodes.length) return;
          const chunkEnd = Math.min(chunkStart + 20, allEpisodes.length);
          renderInitialChunk(allEpisodes, chunkStart, chunkEnd);
          chunkStart = chunkEnd;
          setTimeout(backgroundRender, 100);
        }
        
        if ('requestIdleCallback' in window) {
          requestIdleCallback(backgroundRender);
        } else {
          setTimeout(backgroundRender, 50);
        }
        
        // Auto-play saved episode if resume enabled
        if (savedIndex > 0 && savedIndex < allEpisodes.length && 
            document.getElementById('resumeToggle').checked) {
          setTimeout(() => playEpisode(savedIndex), 500);
        }
        
        applyFilters();
        
      } catch (error) {
        console.error('Playlist load error:', error);
        document.getElementById('playlist').innerHTML = '<div style="padding:1rem;color:#e53e3e;">Error loading playlist. Check console.</div>';
      } finally {
        isLoading = false;
      }
    }

    function playEpisode(index) {
      if (index < 0 || index >= filteredEpisodes.length) return;
      
      currentIndex = index;
      const episode = filteredEpisodes[index];
      
      document.getElementById('player').src = `https://www.youtube.com/embed/${episode.id}?autoplay=1&rel=0`;
      document.getElementById('videoTitle').textContent = episode.title;
      document.getElementById('videoInfo').style.display = 'block';
      
      // Update active card
      document.querySelectorAll('.episode-card').forEach((card, i) => {
        card.classList.toggle('active', i === index);
      });
      
      // Save position
      if (document.getElementById('resumeToggle').checked) {
        localStorage.setItem(LS_LAST_INDEX, String(
          allEpisodes.findIndex(e => e.id === episode.id)
        ));
      }
      
      // Scroll to active card
      const activeCard = document.querySelector('.episode-card.active');
      if (activeCard) activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function applyFilters(autoScroll = true) {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      const rangeValue = document.getElementById('rangeFilter').value;
      
      filteredEpisodes = allEpisodes.filter(episode => {
        const matchesSearch = episode.title.toLowerCase().includes(searchTerm);
        let matchesRange = true;
        
        if (rangeValue !== 'all') {
          const [start, end] = rangeValue.split('-').map(Number);
          const index = allEpisodes.findIndex(e => e.id === episode.id) + 1;
          if (end) {
            matchesRange = index >= start && index <= end;
          } else {
            matchesRange = index >= start;
          }
        }
        
        return matchesSearch && matchesRange;
      });
      
      // Auto-adjust range if search target is outside current range
      if (searchTerm && filteredEpisodes.length > 0 && rangeValue !== 'all') {
        const targetIndex = allEpisodes.findIndex(e => 
          e.title.toLowerCase().includes(searchTerm)
        ) + 1;
        const [rangeStart] = rangeValue.split('-').map(Number);
        if (targetIndex > rangeStart + 99) {
          const newRange = Math.floor((targetIndex - 1) / 100) * 100 + 1;
          const rangeOptions = Array.from(document.getElementById('rangeFilter').options);
          const matchingOption = rangeOptions.find(opt => 
            opt.value === `${newRange}-${newRange + 99}` || 
            (newRange > 701 && opt.value === '701+')
          );
          if (matchingOption) {
            document.getElementById('rangeFilter').value = matchingOption.value;
            applyFilters(false); // Re-apply without recursion
            return;
          }
        }
      }
      
      // Play first result on Enter after search
      const cards = document.querySelectorAll('.episode-card');
      cards.forEach((card, i) => card.classList.toggle('active', i === currentIndex));
      
      if (autoScroll) {
        const activeCard = document.querySelector('.episode-card.active');
        if (activeCard) activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function saveLastIndexIfNeeded() {
      if (currentIndex >= 0 && document.getElementById('resumeToggle').checked) {
        localStorage.setItem(LS_LAST_INDEX, String(currentIndex));
      }
      localStorage.setItem(LS_RANGE_FILTER, document.getElementById('rangeFilter').value);
      localStorage.setItem(LS_RESUME_TOGGLE, document.getElementById('resumeToggle').checked);
    }

    // Event listeners
    document.getElementById('search').addEventListener('input', () => applyFilters());
    document.getElementById('search').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && filteredEpisodes.length > 0) {
        playEpisode(0);
      }
    });
    
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('search').value = '';
      applyFilters();
    });
    
    document.getElementById('rangeFilter').addEventListener('change', () => applyFilters());
    document.getElementById('resumeToggle').addEventListener('change', () => {
      localStorage.setItem(LS_RESUME_TOGGLE, document.getElementById('resumeToggle').checked);
    });
    
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentIndex > 0) playEpisode(currentIndex - 1);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentIndex < filteredEpisodes.length - 1) playEpisode(currentIndex + 1);
    });

    window.addEventListener('beforeunload', saveLastIndexIfNeeded);
    
    // Auto-load playlist on page ready
    window.addEventListener('load', loadPlaylist);
  </script>
</body>
</html>
