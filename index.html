<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tenali Rama – Playlist Browser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="Tenali-Ramakrishna.png">
  <style>
    :root {
      --bg:#121212;
      --fg:#ffffff;
      --accent:#ff3b5c;
      --card:#1e1e1e;
      --radius:8px;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:radial-gradient(circle at top,#1f2a3a 0,#121212 55%,#050509 100%);
      color:var(--fg);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    header {
      padding:10px 16px;
      border-bottom:1px solid #262626;
      background:linear-gradient(90deg,#141824,#241733);
      display:flex;
      align-items:center;
      gap:10px;
    }
    header img.logo {
      width:40px;
      height:40px;
      border-radius:var(--radius);
      object-fit:cover;
    }
    header .title-block {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    h1 {
      margin:0;
      font-size:19px;
    }
    .top-row {
      display:flex;
      gap:10px;
    }
    #search {
      flex:1;
      padding:10px 14px;
      font-size:15px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(15,15,20,.9);
      color:var(--fg);
      outline:none;
    }
    #search:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,59,92,.4);
    }
    #clearBtn {
      padding:0 18px;
      font-size:15px;
      height:40px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(20,20,32,.95);
      color:var(--fg);
      cursor:pointer;
      white-space:nowrap;
    }
    #clearBtn:hover { background:rgba(35,35,55,1); }

    .main {
      flex:1;
      display:flex;
      min-height:0;
    }
    .left {
      flex:3;
      padding:10px 16px 0;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right {
      flex:2;
      padding:10px 10px 0 0;
      border-left:1px solid #262626;
      display:flex;
      flex-direction:column;
      min-width:260px;
      max-width:430px;
      background:linear-gradient(180deg,rgba(15,15,25,.9),rgba(5,5,10,.98));
    }

    #player {
      width:100%;
      height:65vh;
      max-height:720px;
      margin-bottom:8px;
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 18px 40px rgba(0,0,0,.65);
    }

    #err {
      display:none;
      margin-bottom:8px;
      padding:10px 12px;
      border-radius:var(--radius);
      background:#3b1111;
      color:#ffcccc;
      font-size:14px;
    }

    .now-playing {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:10px;
    }
    .now-title {
      font-weight:700;
      font-size:27px; /* +10px increase */
      line-height:1.2;
    }
    .episode-main {
      font-weight:700;
      display:block;
    }
    .episode-date {
      font-weight:300;
      opacity:0.8;
      font-size:0.85em;
      margin-top:2px;
      display:block;
    }
    .nav-buttons {
      display:flex;
      gap:8px;
      flex-shrink:0;
      margin-top:auto;
    }
    .nav-buttons button {
      padding:6px 12px;
      font-size:14px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.2);
      background:rgba(20,20,32,.95);
      color:var(--fg);
      cursor:pointer;
      min-width:70px;
      flex:1;
    }
    .nav-buttons button:disabled {
      opacity:.4;
      cursor:default;
    }
    .nav-buttons button:hover:not(:disabled) {
      background:rgba(35,35,55,1);
    }

    .right-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-size:14px;
    }

    /* Toggle switch, bigger for touch */
    .toggle-wrap {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .switch {
      position:relative;
      display:inline-block;
      width:44px;
      height:24px;
    }
    .switch input {
      opacity:0;
      width:0;
      height:0;
    }
    .slider {
      position:absolute;
      cursor:pointer;
      inset:0;
      background-color:#444;
      transition:.2s;
      border-radius:var(--radius);
    }
    .slider:before {
      position:absolute;
      content:"";
      height:20px;
      width:20px;
      left:2px;
      bottom:2px;
      background-color:white;
      transition:.2s;
      border-radius:var(--radius);
    }
    .switch input:checked + .slider {
      background-color:var(--accent);
    }
    .switch input:checked + .slider:before {
      transform:translateX(20px);
    }

    #rangeSelect {
      padding:6px 10px;
      font-size:15px;
      height:40px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.16);
      background:#151521;
      color:var(--fg);
      min-width:130px;
    }

    #listWrapper {
      flex:1;
      min-height:0;
      overflow-y:auto;
    }
    #list {
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-right:4px;
    }
    .item {
      cursor:pointer;
      display:flex;
      padding:10px;
      border-radius:var(--radius);
      background:linear-gradient(135deg,#191924,#111119);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:0 6px 16px rgba(0,0,0,.6);
      transition:border-color .15s,background .15s,transform .15s,box-shadow .15s;
      align-items:flex-start;
    }
    .item:hover {
      border-color:rgba(255,255,255,.25);
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(0,0,0,.7);
    }
    .item.active {
      border-color:var(--accent);
      background:radial-gradient(circle at top left,#3a1a2f,#15151f);
      box-shadow:0 0 0 1px rgba(255,59,92,.5),0 12px 30px rgba(0,0,0,.8);
    }
    .thumb {
      width:100px;
      height:60px;
      flex-shrink:0;
      border-radius:var(--radius);
      object-fit:cover;
      margin-right:10px;
      background:#000;
    }
    .thumb.lazy {
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    .thumb.loaded {
      opacity: 1;
    }
    .meta { flex:1; min-width:0; }
    .title {
      margin:0 0 4px;
      font-size:15px;
      font-weight:600;
      line-height:1.3;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .num {
      font-size:13px;
      opacity:.7;
    }
    #loading {
      padding:20px 0;
      text-align:center;
      font-size:14px;
    }

    footer {
      padding:8px 16px;
      font-size:12px;
      text-align:center;
      border-top:1px solid #262626;
      background:#09090f;
      color:#aaaaaa;
    }

    @media (max-width:800px) {
      .main { flex-direction:column; }
      .right {
        max-width:none;
        border-left:none;
        border-top:1px solid #262626;
        padding-left:16px;
      }
      #player {
        height:40vh;
      }
      .now-playing {
        gap:12px;
      }
      .now-title {
        font-size:24px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="Tenali-Ramakrishna.png" alt="Tenali Rama" class="logo">
    <div class="title-block">
      <h1>Tenali Rama – Playlist Browser - Version 3.1</h1>
      <div class="top-row">
        <input id="search" placeholder="Search by number or title..." />
        <button id="clearBtn">Clear</button>
      </div>
    </div>
  </header>

  <div class="main">
    <section class="left">
      <div id="player"></div>
      <div id="err"></div>
      <div class="now-playing">
        <div class="now-title" id="nowTitle">Loading first episode…</div>
        <div class="nav-buttons">
          <button id="prevBtn">Previous</button>
          <button id="nextBtn">Next</button>
        </div>
      </div>
    </section>

    <aside class="right">
      <div class="right-top">
        <div class="toggle-wrap">
          <label class="switch">
            <input type="checkbox" id="resumeToggle" checked>
            <span class="slider"></span>
          </label>
          <span>Remember last position</span>
        </div>
        <select id="rangeSelect"></select>
      </div>
      <div id="listWrapper">
        <div id="list">
          <div id="loading">Loading episodes...</div>
        </div>
      </div>
    </aside>
  </div>

  <footer>© 2025 All rights reserved. Ravi Dikshit</footer>

  <script>
    const PLAYLIST_ID = 'PLbZxdQd9WcS0w2N8U1t6A5_GnEeWmRB4Y';
    const API_KEY     = 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8';
    const RANGE_SIZE  = 100;
    const INITIAL_BATCH = 20;
    const CHUNK_SIZE = 80;
    const LS_LAST_INDEX = 'tr_lastEpisodeIndex';
    const LS_LAST_RANGE = 'tr_lastRange';
    const LS_RESUME_ON  = 'tr_resumeOn';

    let allEpisodes = [];
    let filteredEpisodes = [];
    let player = null;
    let currentIndex = -1;

    // 1x1 transparent placeholder
    const PLACEHOLDER = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';

    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);

    function setupLazyLoading() {
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.classList.remove('lazy');
              img.classList.add('loaded');
              observer.unobserve(img);
            }
          });
        }, { rootMargin: '200px 0px' });
        
        document.querySelectorAll('.thumb[data-src]').forEach(img => observer.observe(img));
      }
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '100%',
        videoId: 'l2B074Hnb7E',
        playerVars: { listType:'playlist', list:PLAYLIST_ID },
        events: { onReady: onPlayerReady }
      });
    }

    async function fetchAllPlaylistItems() {
      let items = [];
      let token = '';
      const loadingEl = document.getElementById('loading');

      do {
        const url =
          'https://www.googleapis.com/youtube/v3/playlistItems'
          + '?part=snippet'
          + '&maxResults=50'
          + '&playlistId=' + PLAYLIST_ID
          + '&key=' + API_KEY
          + (token ? '&pageToken=' + token : '');

        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.error) throw json.error;
          items.push(...(json.items || []));
          token = json.nextPageToken || '';
          loadingEl.textContent = 'Loaded ' + items.length + ' episodes...';
        } catch (e) {
          showError('YouTube Data API error: ' + (e.message || e));
          console.error(e);
          return [];
        }
      } while (token && items.length < 1000);

      return items.map((item, i) => {
        const sn = item.snippet || {};
        const thumbs = sn.thumbnails || {};
        const thumbUrl =
          (thumbs.medium && thumbs.medium.url) ||
          (thumbs.high && thumbs.high.url) ||
          (thumbs.standard && thumbs.standard.url) ||
          (thumbs.default && thumbs.default.url) ||
          '';
        return {
          index: i,
          title: sn.title || ('Episode ' + (i + 1)),
          vid: sn.resourceId && sn.resourceId.videoId,
          thumb: thumbUrl
        };
      });
    }

    function buildRangeOptions(total) {
      const sel = document.getElementById('rangeSelect');
      sel.innerHTML = '';
      const totalRanges = Math.ceil(total / RANGE_SIZE);
      for (let r = 0; r < totalRanges; r++) {
        const start = r * RANGE_SIZE + 1;
        const end   = Math.min((r + 1) * RANGE_SIZE, total);
        const opt = document.createElement('option');
        opt.value = String(r);
        opt.textContent = start + '–' + end;
        sel.appendChild(opt);
      }

      const savedRange = localStorage.getItem(LS_LAST_RANGE);
      if (savedRange !== null && Number(savedRange) < totalRanges) {
        sel.value = savedRange;
      } else {
        sel.value = '0';
      }
    }

    function indexToRange(idx) {
      return Math.floor(idx / RANGE_SIZE);
    }

    function applyFilters(adjustRangeForSearch = false) {
      const searchTerm = document.getElementById('search').value.toLowerCase().trim();
      const rangeSel = document.getElementById('rangeSelect');

      if (adjustRangeForSearch && searchTerm && !isNaN(Number(searchTerm))) {
        const num = Number(searchTerm);
        if (num >= 1 && num <= allEpisodes.length) {
          const desiredRange = indexToRange(num - 1);
          if (Number(rangeSel.value) !== desiredRange) {
            rangeSel.value = String(desiredRange);
            localStorage.setItem(LS_LAST_RANGE, rangeSel.value);
          }
        }
      }

      const rangeIdx = Number(rangeSel.value || 0);
      const start = rangeIdx * RANGE_SIZE;
      const end   = start + RANGE_SIZE;

      filteredEpisodes = allEpisodes.filter(ep => {
        const inRange = ep.index >= start && ep.index < end;
        if (!inRange) return false;
        if (!searchTerm) return true;
        return (
          (ep.title && ep.title.toLowerCase().includes(searchTerm)) ||
          String(ep.index + 1).includes(searchTerm)
        );
      });

      renderList();
    }

    function renderList() {
      const list = document.getElementById('list');
      list.innerHTML = '';

      if (!filteredEpisodes.length) {
        list.innerHTML = '<div id="loading">No episodes match.</div>';
        return;
      }

      filteredEpisodes.forEach(ep => {
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = ep.index;
        row.onclick = () => playEpisode(ep.index);
        if (ep.index === currentIndex) row.classList.add('active');

        const img = document.createElement('img');
        img.className = 'thumb lazy';
        img.dataset.src = ep.thumb;
        img.src = PLACEHOLDER;
        img.alt = ep.title;

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <p class="title">${ep.title}</p>
          <p class="num">Episode ${ep.index + 1}</p>
        `;

        row.appendChild(img);
        row.appendChild(meta);
        list.appendChild(row);
      });

      setupLazyLoading();
      
      const active = list.querySelector('.item.active');
      if (active) {
        const wrapper = document.getElementById('listWrapper');
        const target =
          active.offsetTop - wrapper.clientHeight / 2 + active.offsetHeight / 2;
        wrapper.scrollTop = Math.max(target, 0);
      }
    }

    function updateNowPlaying() {
      const tEl = document.getElementById('nowTitle');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (currentIndex < 0 || !allEpisodes[currentIndex]) {
        tEl.innerHTML = 'Select an episode…';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      const ep = allEpisodes[currentIndex];
      const fullTitle = ep.title;
      const epNum = `Ep ${ep.index + 1}: `;
      
      // Extract date from typical format "Tenali Rama - Ep 116 - Full Episode - 15th December, 2017"
      const dateMatch = fullTitle.match(/(\d{1,2}(st|nd|rd|th)\s+(January|February|March|April|May|June|July|August|September|October|November|December),\s+\d{4})/i);
      const date = dateMatch ? dateMatch[0] : '';
      const mainTitle = date ? fullTitle.replace(epNum, '').replace(` - Full Episode - ${date}`, '').trim() : fullTitle.replace(epNum, '').trim();
      
      tEl.innerHTML = `
        <span class="episode-main">${epNum}${mainTitle}</span>
        <span class="episode-date">${date}</span>
      `;
      
      prevBtn.disabled = (currentIndex <= 0);
      nextBtn.disabled = (currentIndex >= allEpisodes.length - 1);
    }

    function saveLastIndexIfNeeded() {
      const resumeOn = document.getElementById('resumeToggle').checked;
      if (resumeOn && currentIndex >= 0) {
        localStorage.setItem(LS_LAST_INDEX, String(currentIndex));
      }
    }

    function playEpisode(idx) {
      if (!player || !allEpisodes[idx]) return;
      currentIndex = idx;

      const vid = allEpisodes[idx].vid;
      if (vid) player.loadVideoById(vid);

      saveLastIndexIfNeeded();
      updateNowPlaying();

      document.querySelectorAll('.item').forEach(el =>
        el.classList.toggle('active', Number(el.dataset.index) === idx)
      );
    }

    function showError(msg) {
      const el = document.getElementById('err');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function initialWindowIndices(targetIdx, total) {
      if (targetIdx == null || isNaN(targetIdx)) {
        return { start:0, end:Math.min(INITIAL_BATCH, total) };
      }
      // Priority window around saved position (e.g., episode 116 area)
      const start = Math.max(targetIdx - 10, 0);
      const end   = Math.min(start + INITIAL_BATCH, total);
      return { start, end };
    }

    async function onPlayerReady() {
      const resumeToggle = document.getElementById('resumeToggle');
      const storedResume = localStorage.getItem(LS_RESUME_ON);
      if (storedResume === null) {
        resumeToggle.checked = true;
      } else {
        resumeToggle.checked = storedResume === '1';
      }
      resumeToggle.addEventListener('change', () => {
        localStorage.setItem(LS_RESUME_ON, resumeToggle.checked ? '1' : '0');
        if (resumeToggle.checked && currentIndex >= 0) {
          localStorage.setItem(LS_LAST_INDEX, String(currentIndex));
        }
      });

      allEpisodes = await fetchAllPlaylistItems();
      if (!allEpisodes.length) return;

      buildRangeOptions(allEpisodes.length);

      const resumeOn = resumeToggle.checked;
      const savedIdx = resumeOn ? localStorage.getItem(LS_LAST_INDEX) : null;
      let startIdxToPlay = 0;

      if (savedIdx !== null) {
        const idx = Number(savedIdx);
        if (!Number.isNaN(idx) && idx >= 0 && idx < allEpisodes.length) {
          startIdxToPlay = idx;
        }
      }

      const win = initialWindowIndices(startIdxToPlay, allEpisodes.length);
      const rangeSel = document.getElementById('rangeSelect');
      const desiredRange = indexToRange(startIdxToPlay);
      rangeSel.value = String(desiredRange);
      localStorage.setItem(LS_LAST_RANGE, rangeSel.value);

      filteredEpisodes = allEpisodes.slice(win.start, win.end);
      renderList();

      // Background: progressively add remaining episodes in chunks
      (async () => {
        let chunkStart = Math.max(win.end, INITIAL_BATCH);
        while (chunkStart < allEpisodes.length) {
          const chunkEnd = Math.min(chunkStart + CHUNK_SIZE, allEpisodes.length);
          const rangeIdx = Number(rangeSel.value || 0);
          const s = rangeIdx * RANGE_SIZE;
          const e = s + RANGE_SIZE;
          filteredEpisodes = allEpisodes.filter(ep => ep.index >= s && ep.index < e);
          renderList();
          chunkStart = chunkEnd;
          await new Promise(r => setTimeout(r, 50));
        }
      })();

      playEpisode(startIdxToPlay);

      const searchEl = document.getElementById('search');
      searchEl.addEventListener('input', () => applyFilters(true));
      searchEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const term = searchEl.value.trim();
          if (!term) {
            // Empty search: do nothing at all
            return;
          }
          e.preventDefault();
          applyFilters(true);
          if (filteredEpisodes.length > 0) {
            playEpisode(filteredEpisodes[0].index);
          }
        }
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        searchEl.value = '';
        applyFilters(false);
      });

      document.getElementById('rangeSelect').addEventListener('change', (e) => {
        localStorage.setItem(LS_LAST_RANGE, e.target.value);
        applyFilters(false);
      });

      document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentIndex > 0) playEpisode(currentIndex - 1);
      });
      document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentIndex < allEpisodes.length - 1) playEpisode(currentIndex + 1);
      });
    }

    window.addEventListener('beforeunload', () => {
      saveLastIndexIfNeeded();
    });
  </script>
</body>
</html>
