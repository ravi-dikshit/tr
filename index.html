<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tenali Rama – Playlist Browser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#121212;
      --fg:#ffffff;
      --accent:#ff0000;
      --card:#1e1e1e;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    header {
      padding:10px 16px;
      border-bottom:1px solid #262626;
    }
    h1 { margin:0 0 4px; font-size:20px; }
    .top-row {
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    #search {
      flex:1;
      padding:8px 10px;
      font-size:14px;
      border-radius:4px;
      border:1px solid var(--accent);
      background:var(--card);
      color:var(--fg);
      outline:none;
    }
    #clearBtn {
      padding:0 10px;
      font-size:13px;
      border-radius:4px;
      border:1px solid #555;
      background:#2b2b2b;
      color:var(--fg);
      cursor:pointer;
      white-space:nowrap;
    }
    #clearBtn:hover { background:#3b3b3b; }

    .main {
      flex:1;
      display:flex;
      min-height:0; /* allow children to scroll */
    }
    .left {
      flex:3;
      padding:10px 16px 16px;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right {
      flex:2;
      padding:10px 10px 10px 0;
      border-left:1px solid #262626;
      display:flex;
      flex-direction:column;
      min-width:260px;
      max-width:420px;
    }

    #player {
      width:100%;
      aspect-ratio:16/9;
      margin-bottom:8px;
    }

    #err {
      display:none;
      margin-bottom:8px;
      padding:8px 10px;
      border-radius:4px;
      background:#3b1111;
      color:#ffcccc;
      font-size:13px;
    }

    .now-playing {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      font-size:14px;
    }
    .now-title {
      flex:1;
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .nav-buttons {
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .nav-buttons button {
      padding:4px 8px;
      font-size:12px;
      border-radius:4px;
      border:1px solid #555;
      background:#2b2b2b;
      color:var(--fg);
      cursor:pointer;
    }
    .nav-buttons button:disabled {
      opacity:.4;
      cursor:default;
    }
    .nav-buttons button:hover:not(:disabled) {
      background:#3b3b3b;
    }

    .right-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      font-size:13px;
    }
    #rangeSelect {
      padding:4px 6px;
      font-size:13px;
      border-radius:4px;
      border:1px solid #555;
      background:#1b1b1b;
      color:var(--fg);
    }

    #listWrapper {
      flex:1;
      min-height:0;
      overflow-y:auto;
    }
    #list {
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-right:4px;
    }
    .item {
      cursor:pointer;
      display:flex;
      padding:8px;
      border-radius:6px;
      background:var(--card);
      border:2px solid transparent;
      transition:border-color .15s,background .15s,transform .15s;
      align-items:flex-start;
    }
    .item:hover {
      border-color:var(--accent);
      transform:translateY(-1px);
    }
    .item.active {
      border-color:var(--accent);
      background:#261111;
    }
    .thumb {
      width:96px;
      height:54px;
      flex-shrink:0;
      border-radius:4px;
      object-fit:cover;
      margin-right:8px;
      background:#000;
    }
    .meta {
      flex:1;
      min-width:0;
    }
    .title {
      margin:0 0 4px;
      font-size:14px;
      font-weight:600;
      line-height:1.3;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .num {
      font-size:12px;
      opacity:.7;
    }
    #loading {
      padding:20px 0;
      text-align:center;
      font-size:13px;
    }

    @media (max-width:800px) {
      .main { flex-direction:column; }
      .right {
        max-width:none;
        border-left:none;
        border-top:1px solid #262626;
        padding-left:16px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tenali Rama – Playlist Browser - Version 2.1</h1>
    <div class="top-row">
      <input id="search" placeholder="Search by number or title..." />
      <button id="clearBtn">Clear</button>
    </div>
  </header>

  <div class="main">
    <section class="left">
      <div id="player"></div>
      <div id="err"></div>
      <div class="now-playing">
        <div class="now-title" id="nowTitle">Select an episode…</div>
        <div class="nav-buttons">
          <button id="prevBtn">Previous</button>
          <button id="nextBtn">Next</button>
        </div>
      </div>
    </section>

    <aside class="right">
      <div class="right-top">
        <span>Episodes</span>
        <select id="rangeSelect"></select>
      </div>
      <div id="listWrapper">
        <div id="list">
          <div id="loading">Loading episodes...</div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const PLAYLIST_ID = 'PLbZxdQd9WcS0w2N8U1t6A5_GnEeWmRB4Y';
    const API_KEY     = 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8';
    const RANGE_SIZE  = 100;
    const LS_LAST_INDEX = 'tr_lastEpisodeIndex';
    const LS_LAST_RANGE = 'tr_lastRange';

    let allEpisodes = [];
    let filteredEpisodes = [];
    let player = null;
    let currentIndex = -1;

    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '100%',
        videoId: 'l2B074Hnb7E',
        playerVars: { listType:'playlist', list:PLAYLIST_ID },
        events: { onReady: onPlayerReady }
      });
    }

    async function fetchAllPlaylistItems() {
      let items = [];
      let token = '';
      const loadingEl = document.getElementById('loading');

      do {
        const url =
          'https://www.googleapis.com/youtube/v3/playlistItems'
          + '?part=snippet'
          + '&maxResults=50'
          + '&playlistId=' + PLAYLIST_ID
          + '&key=' + API_KEY
          + (token ? '&pageToken=' + token : '');

        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.error) throw json.error;
          items.push(...(json.items || []));
          token = json.nextPageToken || '';
          loadingEl.textContent = 'Loaded ' + items.length + ' episodes...';
        } catch (e) {
          showError('YouTube Data API error: ' + (e.message || e));
          console.error(e);
          return [];
        }
      } while (token && items.length < 1000);

      return items.map((item, i) => {
        const sn = item.snippet || {};
        const thumbs = sn.thumbnails || {};
        const thumbUrl =
          (thumbs.medium && thumbs.medium.url) ||
          (thumbs.high && thumbs.high.url) ||
          (thumbs.standard && thumbs.standard.url) ||
          (thumbs.default && thumbs.default.url) ||
          '';
        return {
          index: i,
          title: sn.title || ('Episode ' + (i + 1)),
          vid: sn.resourceId && sn.resourceId.videoId,
          thumb: thumbUrl
        };
      });
    }

    function buildRangeOptions(total) {
      const sel = document.getElementById('rangeSelect');
      sel.innerHTML = '';
      const totalRanges = Math.ceil(total / RANGE_SIZE);
      for (let r = 0; r < totalRanges; r++) {
        const start = r * RANGE_SIZE + 1;
        const end   = Math.min((r + 1) * RANGE_SIZE, total);
        const opt = document.createElement('option');
        opt.value = String(r);
        opt.textContent = start + '–' + end;
        sel.appendChild(opt);
      }

      const savedRange = localStorage.getItem(LS_LAST_RANGE);
      if (savedRange !== null && Number(savedRange) < totalRanges) {
        sel.value = savedRange;
      } else {
        sel.value = '0';
      }
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search').value.toLowerCase().trim();
      const rangeIdx = Number(document.getElementById('rangeSelect').value || 0);
      const start = rangeIdx * RANGE_SIZE;
      const end   = start + RANGE_SIZE;

      filteredEpisodes = allEpisodes.filter(ep => {
        const inRange = ep.index >= start && ep.index < end;
        if (!inRange) return false;
        if (!searchTerm) return true;
        return (
          (ep.title && ep.title.toLowerCase().includes(searchTerm)) ||
          String(ep.index + 1).includes(searchTerm)
        );
      });

      renderList();
    }

    function renderList() {
      const list = document.getElementById('list');
      list.innerHTML = '';

      if (!filteredEpisodes.length) {
        list.innerHTML = '<div id="loading">No episodes match.</div>';
        return;
      }

      filteredEpisodes.forEach(ep => {
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = ep.index;
        row.onclick = () => playEpisode(ep.index);
        if (ep.index === currentIndex) row.classList.add('active');

        row.innerHTML = `
          <img class="thumb" src="${ep.thumb}" alt="${ep.title}" loading="lazy">
          <div class="meta">
            <p class="title">${ep.title}</p>
            <p class="num">Episode ${ep.index + 1}</p>
          </div>
        `;
        list.appendChild(row);
      });

      // Ensure active item is visible inside listWrapper
      const active = list.querySelector('.item.active');
      if (active) {
        const wrapper = document.getElementById('listWrapper');
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < wrapper.scrollTop || bottom > wrapper.scrollTop + wrapper.clientHeight) {
          wrapper.scrollTop = top - 20;
        }
      }
    }

    function updateNowPlaying() {
      const tEl = document.getElementById('nowTitle');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (currentIndex < 0 || !allEpisodes[currentIndex]) {
        tEl.textContent = 'Select an episode…';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      const ep = allEpisodes[currentIndex];
      tEl.textContent = `Ep ${ep.index + 1}: ${ep.title}`;
      prevBtn.disabled = (currentIndex <= 0);
      nextBtn.disabled = (currentIndex >= allEpisodes.length - 1);
    }

    function playEpisode(idx) {
      if (!player || !allEpisodes[idx]) return;
      currentIndex = idx;

      const vid = allEpisodes[idx].vid;
      if (vid) player.loadVideoById(vid);  // autoplay; use cueVideoById if needed

      localStorage.setItem(LS_LAST_INDEX, String(idx));
      updateNowPlaying();

      document.querySelectorAll('.item').forEach(el =>
        el.classList.toggle('active', Number(el.dataset.index) === idx)
      );
    }

    function showError(msg) {
      const el = document.getElementById('err');
      el.textContent = msg;
      el.style.display = 'block';
    }

    async function onPlayerReady() {
      allEpisodes = await fetchAllPlaylistItems();
      if (!allEpisodes.length) return;

      buildRangeOptions(allEpisodes.length);
      applyFilters();

      const savedIdx = localStorage.getItem(LS_LAST_INDEX);
      if (savedIdx !== null) {
        const idx = Number(savedIdx);
        if (!Number.isNaN(idx) && idx >= 0 && idx < allEpisodes.length) {
          playEpisode(idx);
        }
      } else {
        updateNowPlaying();
      }

      document.getElementById('search').addEventListener('input', applyFilters);
      document.getElementById('clearBtn').addEventListener('click', () => {
        document.getElementById('search').value = '';
        applyFilters();
      });
      document.getElementById('rangeSelect').addEventListener('change', (e) => {
        localStorage.setItem(LS_LAST_RANGE, e.target.value);
        applyFilters();
      });

      document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentIndex > 0) playEpisode(currentIndex - 1);
      });
      document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentIndex < allEpisodes.length - 1) playEpisode(currentIndex + 1);
      });
    }

    window.addEventListener('beforeunload', () => {
      if (currentIndex >= 0)
        localStorage.setItem(LS_LAST_INDEX, String(currentIndex));
    });
  </script>
</body>
</html>
