
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Series Browser + Player (PWA)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f1115" />
  <!-- NOTE: use relative paths on GitHub Pages -->
  manifest.json
  assets/icon-192.png
  <style>
    :root { --bg:#0f1115; --fg:#e7e9ee; --muted:#9aa0a6; --accent:#4f8cff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Arial; }
    header { padding:16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #222; }
    input[type="search"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #333; background:#12151b; color:var(--fg); }
    .pill { padding:8px 12px; border:1px solid #333; border-radius:999px; background:#12151b; color:var(--muted); }
    main { display:grid; grid-template-columns: 1fr 380px; gap:0; min-height:calc(100vh - 60px); }
    #player-wrap { padding:16px; border-right:1px solid #222; }
    #list { overflow:auto; }
    .episode { display:flex; gap:10px; padding:10px 12px; border-bottom:1px solid #222; cursor:pointer; }
    .episode:hover, .episode:focus { background:#151924; outline: 2px solid var(--accent); outline-offset: 2px; }
    .thumb { width:120px; height:68px; object-fit:cover; border-radius:6px; background:#222; }
    .meta { display:flex; flex-direction:column; gap:4px; }
    .title { font-size:14px; line-height:1.3; }
    .pos { color:var(--muted); font-size:12px; }
    footer { padding:8px 16px; display:flex; gap:12px; align-items:center; border-top:1px solid #222; }
    button { background:var(--accent); color:white; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.ghost { background:#12151b; color:var(--fg); border:1px solid #333; }
    .small { font-size:12px; color:var(--muted); }
    .hint { color:var(--muted); font-size:12px; padding:8px 16px; }
    .error { color:#ff6b6b; font-size:12px; padding:8px 16px; }
  </style>
</head>
<body>
  <header>
    <input id="q" type="search" placeholder="Search episodes by title…" />
    <div class="pill" id="count">0 episodes</div>
    <button id="resumeBtn" class="ghost" title="Resume last watched">Resume</button>
  </header>

  <main>
    <section id="player-wrap">
      <div id="player" style="aspect-ratio:16/9; width:100%; max-width:960px;"></div>
      <footer>
        <button id="prev">⟸ Prev</button>
        <button id="next">Next ⟹</button>
        <span class="small" id="nowPlaying"></span>
      </footer>
      <div class="hint">
        Tip: Use ↑/↓ to navigate the episode list, Enter to play. On TV, open this URL in Silk/Firefox (Fire TV) or Chrome (Android TV).
      </div>
      <div id="err" class="error" hidden></div>
    </section>

    <section id="list" tabindex="0" aria-label="Episode list"></section>
  </main>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    const API_KEY = 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8'; // optional for enhanced list/search
    const PLAYLIST_ID = 'PLbZxdQd9WcS0w2N8U1t6A5_GnEeWmRB4Y'; // from your URL

    // ==============================
    // STATE
    // ==============================
    const state = { all: [], filtered: [], currentIndex: 0 };

    // ==============================
    // Data API fetch (optional; requires valid API key and referrer configured)
    // ==============================
    async function fetchAllPlaylistItems(playlistId) {
      let pageToken = '';
      const out = [];
      while (true) {
        const url = new URL('https://www.googleapis.com/youtube/v3/playlistItems');
        url.searchParams.set('part','snippet,contentDetails');
        url.searchParams.set('maxResults','50');
        url.searchParams.set('playlistId', playlistId);
        if (pageToken) url.searchParams.set('pageToken', pageToken);
        url.searchParams.set('key', API_KEY);

        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          throw new Error(`YouTube API error ${res.status}: ${txt}`);
        }
        const json = await res.json();

        for (const item of json.items || []) {
          const vid = item.contentDetails?.videoId || item.snippet?.resourceId?.videoId;
          if (!vid) continue;
          out.push({
            videoId: vid,
            title: item.snippet?.title ?? '(untitled)',
            thumb: item.snippet?.thumbnails?.medium?.url
              || item.snippet?.thumbnails?.default?.url
              || ''
          });
        }
        pageToken = json.nextPageToken || '';
        if (!pageToken) break;
      }
      return out.map((x, i) => ({...x, index:i}));
    }

    // ==============================
    // Render list
    // ==============================
    function renderList(items) {
      const list = document.getElementById('list');
      list.innerHTML = '';
      document.getElementById('count').textContent = `${items.length} episodes`;
      const frag = document.createDocumentFragment();
      items.forEach(ep => {
        const row = document.createElement('div');
        row.className = 'episode';
        row.dataset.index = ep.index;
        row.tabIndex = 0; // TV/keyboard focus
        row.innerHTML = `
          <img class="thumb" src="${ep.thumb}" alt
            <div class="title">${ep.title}</div>
            <div class="pos">#${ep.index + 1}</div>
          </div>`;
        row.addEventListener('click', () => playAtIndex(ep.index));
        frag.appendChild(row);
      });
      list.appendChild(frag);
      state.filtered = items;
    }

    // search/filter
    document.getElementById('q').addEventListener('input', () => {
      const term = document.getElementById('q').value.trim().toLowerCase();
      const filtered = term ? state.all.filter(ep => ep.title.toLowerCase().includes(term)) : state.all;
      renderList(filtered);
    });

    // ==============================
    // PWA service worker register (relative path)
    // ==============================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('service-worker.js'); // relative
          console.log('SW registered', reg);
        } catch (e) {
          console.warn('SW registration failed', e);
        }
      });
    }

    // ==============================
    // YouTube IFrame Player
    // ==============================
    let player;
    const ytTag = document.createElement('script');
    ytTag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(ytTag);

    window.onYouTubeIframeAPIReady = async function () {
      // 1) Create player with direct playlist ID (works even without API key)
      player = new YT.Player('player', {
        height: '540',
        width: '960',
        playerVars: { listType: 'playlist', list: PLAYLIST_ID, playsinline: 1 },
        events: { onReady: onReady, onStateChange: onStateChange }
      });

      // 2) Try to fetch items to build searchable UI (optional)
      if (API_KEY && API_KEY !== 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8') {
        try {
          state.all = await fetchAllPlaylistItems(PLAYLIST_ID);
          if (state.all.length) {
            renderList(state.all);
            const ids = state.all.map(x => x.videoId);
            player.loadPlaylist(ids); // lock order + playVideoAt(index) support
            setNowPlaying(0);
          }
        } catch (err) {
          console.warn('Playlist fetch failed:', err);
          showError('Data API fetch failed. Check your API key or referrer restrictions. Player will still work.');
        }
      } else {
        showError('Search/filter needs an API key. Playback works via direct playlist.');
      }
    };

    function onReady() {
      const saved = JSON.parse(localStorage.getItem('series_resume') || '{}');
      if (saved && Number.isInteger(saved.index)) {
        state.currentIndex = saved.index;
        player.playVideoAt(saved.index);
        if (typeof saved.time === 'number') player.seekTo(saved.time, true);
        setNowPlaying(saved.index);
      } else {
        setNowPlaying(0);
      }
    }

    function onStateChange(e) {
      const s = e.data;
      if (s === YT.PlayerState.PLAYING) setNowPlaying(state.currentIndex);
      if (s === YT.PlayerState.PAUSED || s === YT.PlayerState.ENDED) {
        localStorage.setItem('series_resume', JSON.stringify({
          index: state.currentIndex, time: player.getCurrentTime()
        }));
        if (s === YT.PlayerState.ENDED) {
          if (state.all.length) next(); else player.nextVideo();
        }
      }
    }

    function playAtIndex(i) { state.currentIndex = i; player.playVideoAt(i); setNowPlaying(i); }
    function prev() { const i = Math.max(0, state.currentIndex - 1); playAtIndex(i); }
    function next() { const i = Math.min((state.all.length || 999) - 1, state.currentIndex + 1); playAtIndex(i); }
    document.getElementById('prev').onclick = prev;
    document.getElementById('next').onclick = next;

    document.getElementById('resumeBtn').onclick = () => {
      const saved = JSON.parse(localStorage.getItem('series_resume') || '{}');
      if (saved && Number.isInteger(saved.index)) {
        playAtIndex(saved.index);
        if (typeof saved.time === 'number') player.seekTo(saved.time, true);
      }
    };

    function setNowPlaying(i) {
      const now = document.getElementById('nowPlaying');
      const ep = state.all[i];
      now.textContent = ep ? `Now playing: #${i+1} — ${ep.title}` : `Playing episode #${i+1}`;
      document.querySelectorAll('.episode').forEach(el => {
        el.style.outline = (Number(el.dataset.index) === i) ? '1px solid var(--accent)' : 'none';
      });
    }

    function showError(msg) {
      const el = document.getElementById('err');
      el.textContent = msg;
      el.hidden = false;
    }
  </script>
</body>
</html>

