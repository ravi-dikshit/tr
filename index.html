<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tenali Rama – Playlist Browser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#121212;
      --fg:#ffffff;
      --accent:#ff0000;
      --card:#1e1e1e;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      padding:20px;
      max-width:1400px;
      margin-inline:auto;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    h1 { margin:0 0 12px; font-size:24px; }
    #search {
      width:100%;
      padding:10px 12px;
      margin:8px 0 16px;
      font-size:16px;
      border-radius:6px;
      border:1px solid var(--accent);
      background:var(--card);
      color:var(--fg);
      outline:none;
    }
    #player {
      width:100%;
      height:360px;
      margin-bottom:16px;
    }
    @media (min-width:900px) {
      #player { height:480px; }
    }
    #err {
      display:none;
      margin-bottom:12px;
      padding:10px 12px;
      border-radius:6px;
      background:#3b1111;
      color:#ffcccc;
      font-size:14px;
    }
    #list {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:10px;
    }
    .item {
      cursor:pointer;
      display:flex;
      padding:10px;
      border-radius:8px;
      background:var(--card);
      border:2px solid transparent;
      transition:border-color .15s,transform .15s,background .15s;
      align-items:flex-start;
    }
    .item:hover {
      border-color:var(--accent);
      transform:translateY(-1px);
    }
    .item.active {
      border-color:var(--accent);
      background:#261111;
    }
    .thumb {
      width:96px;
      height:54px;
      flex-shrink:0;
      border-radius:4px;
      object-fit:cover;
      margin-right:10px;
      background:#000;
    }
    .meta {
      flex:1;
      min-width:0;
    }
    .title {
      margin:0 0 4px;
      font-size:15px;
      font-weight:600;
      line-height:1.3;
    }
    .num {
      font-size:13px;
      opacity:.7;
    }
    #loading {
      padding:40px 0;
      text-align:center;
      grid-column:1/-1;
    }
  </style>
</head>
<body>
  <h1>Tenali Rama – Playlist Browser</h1>
  <input id="search" placeholder="Search episodes by number or title..." />
  <div id="player"></div>
  <div id="err"></div>
  <div id="list">
    <div id="loading">Loading episodes...</div>
  </div>

  <script>
    // ===== CONFIG =====
    const PLAYLIST_ID = 'PLbZxdQd9WcS0w2N8U1t6A5_GnEeWmRB4Y';
    const API_KEY     = 'AIzaSyBf59EBerbLGOSeL1R12VIJrNqAu89F8l8';

    // ===== STATE =====
    let allEpisodes = [];
    let player = null;
    let currentIndex = -1;

    // ===== LOAD YOUTUBE IFRAME API =====
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);

    // Called by YouTube API when it is ready
    function onYouTubeIframeAPIReady() {
      // Use first episode as safe default; playlist also attached via playerVars
      player = new YT.Player('player', {
        height: '360',
        width: '100%',
        videoId: 'l2B074Hnb7E',
        playerVars: {
          listType: 'playlist',
          list: PLAYLIST_ID
        },
        events: { onReady: onPlayerReady }
      });
    }

    // Fetch all items from playlist (handles pagination)
    async function fetchAllPlaylistItems() {
      let items = [];
      let token = '';
      let page = 0;
      const loadingEl = document.getElementById('loading');

      do {
        const url =
          'https://www.googleapis.com/youtube/v3/playlistItems'
          + '?part=snippet'
          + '&maxResults=50'
          + '&playlistId=' + PLAYLIST_ID
          + '&key=' + API_KEY
          + (token ? '&pageToken=' + token : '');

        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.error) throw json.error;

          items.push(...(json.items || []));
          token = json.nextPageToken || '';
          page++;
          loadingEl.textContent = 'Loaded ' + items.length + ' episodes...';
        } catch (e) {
          showError('YouTube Data API error on page ' + page + ': ' + (e.message || e));
          console.error(e);
          return [];
        }
      } while (token && items.length < 1000);

      // Map to simpler structure with robust thumbnail handling
      return items.map((item, i) => {
        const sn = item.snippet || {};
        const thumbs = (sn.thumbnails) || {};
        const thumbUrl =
          (thumbs.medium && thumbs.medium.url) ||
          (thumbs.high && thumbs.high.url) ||
          (thumbs.standard && thumbs.standard.url) ||
          (thumbs.default && thumbs.default.url) ||
          '';

        return {
          index: i,
          title: sn.title || ('Episode ' + (i + 1)),
          vid: sn.resourceId && sn.resourceId.videoId,
          thumb: thumbUrl
        };
      });
    }

    function renderList(filtered) {
      const list = document.getElementById('list');
      list.innerHTML = '';

      if (!filtered.length) {
        list.innerHTML = '<div id="loading">No episodes match the search.</div>';
        return;
      }

      filtered.forEach(ep => {
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = ep.index;
        row.onclick = () => playEpisode(ep.index);

        row.innerHTML = `
          <img class="thumb" src="${ep.thumb}" alt="${ep.title}" loading="lazy">
          <div class="meta">
            <p class="title">${ep.title}</p>
            <p class="num">Episode ${ep.index + 1}</p>
          </div>
        `;

        list.appendChild(row);
      });

      // Mark active
      if (currentIndex >= 0) {
        document
          .querySelectorAll('.item')
          .forEach(el => el.classList.toggle('active',
            Number(el.dataset.index) === currentIndex));
      }
    }

    function playEpisode(idx) {
      if (!player || !allEpisodes[idx]) return;

      currentIndex = idx;
      const vid = allEpisodes[idx].vid;
      if (!vid) return;

      // Load just this video by ID; playlist is still attached via playerVars
      player.loadVideoById(vid); // use cueVideoById(vid) if you want no autoplay

      // Highlight row
      document
        .querySelectorAll('.item')
        .forEach(el => el.classList.toggle('active',
          Number(el.dataset.index) === idx));

      localStorage.setItem('lastEpisodeIndex', String(idx));
    }

    function showError(msg) {
      const el = document.getElementById('err');
      el.textContent = msg;
      el.style.display = 'block';
    }

    async function onPlayerReady() {
      allEpisodes = await fetchAllPlaylistItems();
      if (!allEpisodes.length) return;

      renderList(allEpisodes);

      // Restore last watched episode if available
      const saved = localStorage.getItem('lastEpisodeIndex');
      if (saved !== null) {
        const sIdx = parseInt(saved, 10);
        if (!Number.isNaN(sIdx) && sIdx >= 0 && sIdx < allEpisodes.length) {
          playEpisode(sIdx);
        }
      }

      // Wire up search
      const search = document.getElementById('search');
      search.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase().trim();
        if (!term) {
          renderList(allEpisodes);
          return;
        }
        const filtered = allEpisodes.filter(ep =>
          (ep.title && ep.title.toLowerCase().includes(term)) ||
          (String(ep.index + 1).includes(term))
        );
        renderList(filtered);
      });
    }

    // Save current index when leaving page
    window.addEventListener('beforeunload', () => {
      if (currentIndex >= 0)
        localStorage.setItem('lastEpisodeIndex', String(currentIndex));
    });
  </script>
</body>
</html>
